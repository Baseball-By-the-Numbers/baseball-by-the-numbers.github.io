---
layout: post
published: true
title: Too many anigrams
date: 2022/09/19
subtitle: How many generations of humanity will pass before anigrams has a repeat?
tags:
---

>**Question:** In the game of Anigrams, you unscramble successively larger, nested collections of letters to create a valid “chain” of six English words between four and nine letters in length.
>
>For example, a chain of five words (sadly, less than the six needed for a valid game of Anigrams) can be constructed using the following sequence, with each term after the first including one additional letter than the previous term:
>
>DEIR (which unscrambles to make the words DIRE, IRED or RIDE)
>DEIRD (DRIED or REDID)
>DEIRDL (DIRLED, DREIDL or RIDDLE)
>DEIRDLR (RIDDLER)
>DEIRDLRS (RIDDLERS)
>What is the longest chain of such nested anagrams you can create, starting with four letters?
>
>For specificity, all valid words must come from Peter Norvig’s [word list](https://norvig.com/ngrams/enable1.txt) (a list we’ve used previously here at The Riddler).
>
>Extra credit: How many possible games of Anigrams games are there? That is, how many valid sets are there of four initial letters, and then five more letters added one at a time in an ordered sequence, that result in a sequence of valid anagrams? (Note: Swapping the order of the first four letters does not result in a distinct game.)

<!--more-->

([FiveThirtyEight](URL))

## Solution

The sketch below shows the potential sequence of plays for a winning game of anigrams on the left, and the underlying game on the right. For any given stage, there may be multiple words that can be formed from the letter set.

![](/img/2022-09-19-anigrams.png){:width="450 px" class="image-centered"}

<!-- To build a valid game of anigrams, we need to find a list of $9$ letters that form a word, and remove letters from the list, one at a time, such that at least one real word can be formed at each stage. -->

To build a valid game of anigrams, we just need to pick a sequence of $4$ letters, and add letters one at a time, such that at every stage, at least one real word can be formed from the letters.

# Algorithm

This suggests an efficient way to build anigram games. First, we turn every $4$ letter word into a unique barcode and add it to a set `good_barcodes`. Then, we go through each $5$ letter word, removing one letter at a time to form the barcodes that could have preceded it, and check if any of those are in the set of `good_barcodes`. If at least one is, then we barcode that $5$ letter word, and add its barcode to the list of `good_barcodes`. This ensures that the only barcodes in the set are those that have an ancestor in the set.

At the end of this process, the longest barcode(s) in `good_barcodes` will be the anigram game(s) we're looking for. Knowing that the game exists is one thing, but we'd also like to be able to efficiently recreate it. To do this, we'll log the sample sub-words for each of a word's valid sub-barcodes in the map `precursors`.


# Coding

To start, we write a function to turn any word into the corresponding barcode

```python
def word_to_barcode(word):
  return "".join(sorted(word))
```

and initialize the set `good_barcodes`

```python
initial_words = [word for word in words if len(word) == 4]
```

To be able to easily convert from barcodes back to words, we make a map from barcodes to words

```python
from typing_extensions import DefaultDict
barcode_to_word = DefaultDict()

for word in words:
  barcode_to_word[word_to_barcode(word)] = word
```

Now, we make a linear pass over the list to build the set `good_barcodes`

```python
# keep track of which words have sub-barcodes
good_barcodes = set(word_to_barcode(word) for word in initial_words)

# store precursor words
precursors = DefaultDict(lambda: set())

for word in words:
  
  # make potential precursor barcodes for each word by removing each letter
  sub_word_barcodes = [word_to_barcode(word[0:i-1] + word[i:]) for i in range(1, len(word)+1)]
  
  # loop over the potential sub-barcodes to see if any already exist in good_barcodes
  # if so, add current barcode to good_barcodes, log sample sub-word in precursors
  for sub_word_barcode in sub_word_barcodes:
  
    if sub_word_barcode in good_barcodes:
      good_barcodes.add(word_to_barcode(word))
      precursors[word].add(barcode_to_word[sub_word_barcode])
 ```
 
 With this in hand, we can simply find the barcodes of maximum length
 
 ```python
longest = max(good_barcodes, key=lambda x: len(x))
longest_barcodes = [barcode for barcode in good_barcodes if len(barcode) == len(longest)]
longest_words = [word for word in words if word_to_barcode(word) in longest_barcodes]
list(zip(longest_barcodes, longest_words))
```

which produces 

```python
[('adeeiiimnnnorstt', 'indeterminations'),
 ('adeeiimnnorssttu', 'underestimations')]
```

So, there are two longest anigram games, ending in the $16$-letter words `indeterminations` and `underestimations`.

We can walk backwards through precursors to resurrect sample gameplay. 

For `indeterminations`:

```python
['indeterminations',
 'intermediations',
 'determinations',
 'antimodernist',
 'terminations',
 'nitrosamine',
 'antinomies',
 'nominates',
 'sonatine',
 'stanine',
 'anenst',
 'anent',
 'neat']
 ```
 
 and for `underestimations`:
 
 ```python
 ['underestimations',
 'underestimation',
 'determinations',
 'antimodernist',
 'terminations',
 'nitrosamine',
 'antinomies',
 'nominates',
 'sonatine',
 'stanine',
 'anenst',
 'anent',
 'neat']
 ```
 
The games are identical up until the second to last word, where adding a `u` or an `i` is the determining step. At the outer limits of the game, we should expect an exceptional sequence of mutations, so maybe it's not so surprising that the two longest games have the same origin.

# Extra credit

We can use the `precursors` map to count the number of valid anigram games starting from a given terminal word. We just recurse through `precursors` and add up the number of paths, returning `1` when we reach a $4$-letter word

```python
from functools import lru_cache

@lru_cache(maxsize=1_000_000)
def count_anigrams(word):
  # count the number of anigram paths for a given word
  if len(word) == 4:
    return 1
  else:
    return sum(count_anigrams(_) for _ in precursors[word])
```

Accounting for all possible terminal words at each stage, we find there are $4,510,515$ possible regulation games of anigrams, and a max around terminal words of length $11$ or $12$. For the two longest games, the possibilities split up into $1,071$ possibilities apiece.

```python
(4, 2674)
(5, 15915)
(6, 82932)
(7, 403416)
(8, 1603310)
(9, 4510515)
(10, 8660949)
(11, 11437610)
(12, 10826426)
(13, 6614053)
(14, 2394474)
(15, 623854)
(16, 2142)
(17, 0)
```


<br>

<!-- 2022-09-19-words-to-barcodes.png -->
