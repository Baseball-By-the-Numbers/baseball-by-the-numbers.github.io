---
layout: post
published: true
title: Trillions of Toy Towers
date: 2020/07/12
---

>Question: Mira the baby architect has a tapering post and some rings. If placed alone, each ring will "find its height" and rest there. If a ring with a higher rest height is placed before one with a lower rest height, the higher one will cut the bottom of the post off from ring placement. How many different ways are there to stack a ring tower?

<!--more-->

([FiveThirtyEight](https://fivethirtyeight.com/features/can-you-make-24/))

## Solution

This solution has two phases:

1. Getting the structure of the problem
2. Solving the resulting recurrence relation

We'll get at the structure of the problem in two passes. 

### Structure

First some notation. If there are $m$ available heights, and $n$ remaining rings, then we say we have an $S(m,n)$ problem. As we'll see soon, there's no need to track the identities of the remaining rings.

Imagine we start with the bare post and $4$ rings. As there are $4$ rings and $4$ open heights, we'll call this the $(4,4)$ stacking problem, or $S(4,4).$ 

If we drop ring $4$ first, then it will settle to the bottom and we'll have $3$ rings with $3$ open slots, e.g., $S(3,3).$ We could also stop there, so the total number of cases where ring $4$ is placed first is $S(3,3) + 1.$ We could also drop ring $3$ first, which would settle at its height, and leave us to figure out how to place the $3$ remaining rings at the $2$ remaining heights. Or we could choose to stop there. These contribute $S(2,3) + 1.$ Carrying on, we'd get $S(1,3) + 1$ if we placed ring $2$ first. Finally, we have to add $1$ for the case where we skip straight to placing ring $1$ first. 

Altogether, this becomes

$$
\begin{align}
S(5,5) =\ &\overbrace{(1+S(4,4))}^\text{place 5 first} + \overbrace{(1+S(3,4))}^\text{place 4 first} + \\ &\overbrace{(1+S(2,4))}^\text{place 3 first} + \overbrace{(1+S(1,4))}^\text{place 2 first} + \\
&\overbrace{1}^\text{place 1 first}
\end{align}
$$

Or, collecting terms

$$S(5,5) = 5 + S(1,4) + S(2,4) + S(3,4) + S(4,4)$$

This process spawned $S(4,4)$ which is the same problem as the original, just with one less ring and one less height. It also spawned $S(3,4)$ and $S(2,4),$ and $S(1,4)$ which are new. 

We can deal with $S(1,4)$ first. This is just the problem of picking $1$ out of $4$ rings to put at $1$ open height. The answer is $4$ and, in general, we can say  $S(1,n)=n.$

With $S(3,4),$ two of the four remaining rings can be chosen to sit at height $3$. We'll then have an $S(2,3)$ problem as well as the option to call it quits and place no further rings. Since we have two choices of which ring to place at height $3$, our choice is arbitrary and both contribute the same number of cases: $2\cdot\left(S(2,3) + 1)\right)$. We could also place ring $2$ first which would give us the choice between a $S(1,3)$ problem, or calling it quits.

`<drawing of the S(3,4) cases>`

In all,

$$S(3,4) = 2\left(S(2,3) + 1\right) + \left(S(1,3) + 1\right).$$

Similarly, the $S(2,4)$ problem give us $3$ choices of ring that could sit at height $2$. After that, we have a $S(1,3)$ problem. We also have the option to stop where we are. So,

$$S(2,4) = 3\left(S(1,3) + 1\right) + 1$$

These cases contain the general logic: if we don't place the rings in order then we'll have extras, giving $n-m+1$ equivalent choices if we want to place a ring at the next available position (height $m$). Otherwise we have a unique choice at the other remaining positions. In all cases, we get a new subproblem with with $(n-1)$ total rings:

$$\begin{align}
S(m,n) &= (n-m+1)\left(S(m-1,n-1) + 1\right) + \sum\limits_{i=1}^{m-1}\left(1 + S(i,n-1)\right) + 1 \\
       &= n + (n-m)S(m-1,n-1) + \sum\limits_{i=1}^{m-1}S(i,n-1)
\end{align}$$

### Recursion relation

What I will now relay is the happy endng of the story. Afterward I will give a glimpse into the darkness â€” a tragic episode where I stayed staring into a generating function shaped mirage, only to give up all hope at a solution. After a cajoling by Pi Han Goh, I was inspired to give the recurrence one last try. With no further ado, I present the resolution.

At first glance, the recurrence is no joke. It descends levels in two indices, there's the $n$, and there's the $(n-m)$ on $S(m-1,n-1),$ and there's the sum. You just don't see these every day (maybe you do, but I don't).

After calculating some of the $S(m,n)$ by hand, we observed that $S(1,3)=3$ and $S(2,3)=7$ are separated by $4,$ $S(3,4)=21$ and $S(2,4)=13$ are separated by $8,$ and $S(4,5)=64$ and $S(3,5)=48$ are separated by $16$. If this generalizes, then we'd have 

$$S(n-1,n) - S(n-2,n) = 2^{n-1}.$$

At this point I wasn't expecting much, but it seemed like a small piece that might be provable. Using the recurrence relation,

$$\begin{align}
S(n-1,n) - S(n-2,n) &=\left[n + 1\cdot S(n-2,n-1) + \sum\limits_{i=1}^{n-2}S(i,n-1)\right] \\
                    & -\left[n + 2\cdot S(n-3,n-1) + \sum\limits_{i=1}^{n-3}S(i,n-1)\right] \\
                    &= 2S(n-2,n-1) + \sum\limits_{i=1}^{n-3}S(i,n-1) \\
                    & -2S(n-3,n-1) - \sum\limits_{i=1}^{n-3}S(i,n-1) \\
                    &= 2\cdot\left(S(n-2,n-1) - S(n-3,n-1)\right)
\end{align}$$

So, the difference between the $(m=n-1)$ and $(m=n-2)$ coefficients with $n$ rings is replaced with twice the difference between the corresponding coefficients in the $n-1$ ring problem. Following this down, we get 

$$\begin{align}
S(n-1,n) - S(n-2,n) &= 2\cdot\left(S(n-2,n-1) - S(n-3,n-1)\right) \\
                    &= 2^2\left(S(n-3,n-2) - S(n-4,n-2) \\
                    &= 2^3\left(S(n-4,n-3) - S(n-5,n-3) \\
                    &= \cdots \\
                    &= 2^(n-2)\left(S(1,2)-S(0,2)\right) \\
                    &= 2^{n-1}
\end{align}$$

A small miracle, which got me thinking, what about $S(n-2,n) - S(n-3,n)$. Applying the same approach yields 

$$S(n-2,n) - S(n-3,n) = 3\cdot\left(S(n-3,n-2) - S(n-4,n-2)\right)$$

which recurses $n-3$ times down to $3^{n-3}\left(S(1,3) - S(0,3)\right) = 3^{n-2}.$

And so, the rest flowed down like a waterfall. Carrying on in this way can get all the pairwise differences so that 

$$\begin{array}{|c|c|}
\Delta & \text{Value} \\ \hline
S(n,n) - S(n-1,n) & 1^n \\ \hline
S(n-1,n)-S(n-2,n) & 2^{n-1} \\ \hline
S(n-2,n)-S(n-3,n) & 3^{n-2} \\ \hline
S(n-3,n)-S(n-4,n) & 4^{n-3} \\ \hline
\ldots & \ldots \\ \hline
S(3,n) - S(2,n) & \left(n-2\right)^3 \\ \hline
S(2,n) - S(1,n) &  \left(n-1\right)^2 \\ \hline
S(1,n) - S(0,n) & n^1 
\end{array}$$

But these are not mere amusements. Nay, the sum of these differences telescope to the $S(n,n)$ coefficient itself. I hereby present, the number of ways for Mira to stack $n$ rings:

$$S(n,n) = 1^n + 2^{n-1} + 3^{n-2} + \ldots + (n-2)^3 + (n-1)^2 + n.$$

For the case at hand, we get $S(5,5) = 1^5 + 2^4 + 3^3 + 4^2 + 5^1 = 65.$

### Solution attempts

### Regret

### Telescope

<br>
